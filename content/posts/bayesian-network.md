---
title: "pgmpyを使ってあそぼ~ベイジアンネットワーク~"
date: 2021-02-04T02:05:51+09:00
draft: false
tags: ["Bayesian-Network"]
categories: ["Statistics"]
images: ["/images/thumbnails/bayesian-net.png"]
---

こんにちは、ぬまです。  
今回はpythonで「pgmpy」というライブラリを使って観測データからベイジアンネットワークを構築して、構築したネットワークから新たなデータをサンプルすることをしてみようと思います。  
ベイジアンネットワークを使う機会があったのですが、調べても該当する記事が無かったり、さまざまなライブラリがある中で僕がやりたいこととマッチする記事やライブラリがうまく見つからなかったため、今後ベイジアンネットワークを使う人のためや僕自身のメモとして残そうと思います。  
本記事はベイジアンネットワークってなんぞや、という人から、ベイジアンネットワーク使おうとしているけどいまいちプログラムが書けないという人を想定していますので、ベイジアンネットワークを１から実装しようとしている人や、ベイジアンネットワーク完全理解したよー✋という人は想定していないので、悪しからず。  

## ベイジアンネットワークとは
そもそも、ベイジアンネットワーク(以下、BN)とは、さまざまな物事の因果関係をグラフとして表わすことで視覚的に理解することができる且つ物事の関係性を確率で表すことができる非循環有向グラフ(以下、DAG)です。ざっくりいうとベイズの定理によるグラフ構造ですね！
(DAGとは、ネットワーク間に矢印があり、矢印をたどっても絶対にループがないグラフのこと。)  
これだけで、BNを理解できた人は天才です。僕には呪文にしか感じませんでした。。  
例えば、以下のようなネットワークがあったとします。
{{< figure src="/images/BN-ex.png" class="center" width="200" >}}  
X1, X2, X3の丸のことをノードといい、ノードから出ている矢印のことを辺、もしくはエッジと言います。BNでは、各ノードが確率変数になっていて、例えば、事象X1が起こる確率は事象X2と事象X3に依存していることがわかります。  
BNのうれしいことはX1が起きた時に原因がX2なのかX3なのか確率的に予測できるという点です。今、以下の図のような確率がわかっているとします。   
{{< figure src="/images/BN-cpds.png" class="center" width="500" >}}  
この表からわかることは、X2, X3それぞれの0,1の起こる確率とX2, X3がわかった時のX1の0,1の確率がわかるということです(1=起きた, 0=起きていない)。この表のことを条件付き確率表(CPD)といいBNではこの表とネットワークの構造がわからないとなにもできません。  
#### ベイズの定理を使って原因を探る  
では、ベイズの定理を使ってX1が1だとわかった時に、それが何が原因である確率が高いのか調べたいと思います。  
まず、P(X1=1)の確率を知りたいので、周辺化します。  
$$P(X1=1,X2=0,X3=0) = P(X1=1|X2=0,X3=0)P(X2=0)P(X3=0) $$
$$ = 0.4 \times 0.7 \times 0.4 = 0.112$$
$$P(X1=1,X2=0,X3=1) = P(X1=1|X2=0,X3=1)P(X2=0)P(X3=1)$$
$$= 0.8\times0.7\times0.6=0.336$$
$$P(X1=1,X2=1,X3=0) = P(X1=1|X2=1,X3=0)P(X2=1)P(X3=0)$$
$$= 0.5\times0.3\times0.4=0.06$$
$$P(X1=1,X2=1,X3=1) = P(X1=1|X2=1,X3=1)P(X2=1)P(X3=1)$$
$$= 0.7\times0.3\times0.6=0.126$$
$$∴P(X1=1) = 0.634$$
周辺化できたので、実際に各確率を計算してみます。
$$P(X2=0, X3=0|X1=1)=\frac{P(X1=1|X2=0, X3=0)P(X2=0, X3=0)}{P(X1=1)}$$
$$= \frac{0.4\times0.7\times0.4}{0.634}$$
$$=0.1766$$
$$P(X2=0, X3=1|X1=1)=\frac{P(X1=1|X2=0, X3=1)P(X2=0, X3=1)}{P(X1=1)}$$
$$= \frac{0.8\times0.7\times0.6}{0.634}$$
$$=0.5299$$
$$P(X2=1, X3=0|X1=1)=\frac{P(X1=1|X2=1, X3=0)P(X2=1, X3=0)}{P(X1=1)}$$
$$= \frac{0.5\times0.3\times0.4}{0.634}$$
$$=0.0946$$
$$P(X2=1, X3=1|X1=1)=\frac{P(X1=1|X2=1, X3=1)P(X2=1, X3=1)}{P(X1=1)}$$
$$= \frac{0.7\times0.3\times0.6}{0.634}$$
$$=0.1987$$
以上より、$$P(X2=0, X3=1|X1=1)=0.5299$$
が一番確率が高いことがわかるので、X1が起きた時に53%程度の確率でX3が原因であるということがわかりました。BNの恩恵はわかりましたか？  
## ベイジアンネットワークの構築  
以上の例は、BNが事前にわかっているため利用することができました。BNの構造がわかっていない状態ではどうするのか、構築方法について一例を紹介します。  
BNの構築方法は主に2つの要素に分けられます。  
1. 評価指標  
2. 良いネットワークの探索  

この2つの要素を決定して探索します。1の評価指標とはネットワークの良し悪しを決める評価値で学習データに対してネットワークを比べることができます。2の探索はさまざまなネットワークを構築してよりよいネットワークを探すといった探索行為になります。  
このネットワークに対する評価方法や探索方法はさまざまな研究が行われているので、興味がある人は調べてみてください。  
pgmpyには
* BDeu Score  
* Bic Score  
* K2 Score  

という評価基準があります。ざっくりいうと、BDeuとはBayesianDirichlet(BD)という評価方法に必要な事前知識を事前分布に与えることが難しいのでそれをうまく拡張した手法で評価します。BICとはベイズ情報量基準のことでベイズ情報量基準にしたがって評価します。K2 Scoreは先程のBDという評価基準の特定のバージョンのことです。（違ったらごめんなさい。。）  
また、探索方法はpgmpyには
1. Exhaustive Search  
2. Hill Climb Seach  

が用意されています。1は全探索でノードが６以上になると実行できません。2は山登り法で近隣のネットワークの中で最適な解を探索してくれます。  
では、実際にプログラムをつくっていきます。
## pgmpyを使ってBNを構築して遊んでみる
#### ベイジアンネットワーク構築
プログラムを書いてやっていきましょう！  
まず、今回使用するライブラリ[pgmpy](http://pgmpy.org/index.html)をインストールします。
```python
pip install pgmpy
```
condaやcolabの方はcondaやpip!でインストールしてください。  
まず、利用するライブラリとネットワークを構築するためのデータを作成します。
```python
import numpy as np
import pandas as pd
from pgmpy.estimators import K2Score, HillClimbSearch, ExhaustiveSearch
from pgmpy.sampling import BayesianModelSampling
from pgmpy.models import BayesianModel

# generate data
data = pd.DataFrame(np.random.randint(0, 2, size=(5000, 3)), columns=['X1', 'X2', 'X3'])
data['X1'] = data["X2"] + data["X3"] # X3 -> X1 <- x2
print(data)
```  
では、データを元にK2Scoreを使った山登り法でネットワークを構築します。  
```python
# search the best network from data
network = HillClimbSearch(data, scoring_method=K2Score(data))
best_network = network.estimate()
edges = best_network.edges()
nodes = best_network.nodes()
print(edges)
# [('X2', 'X1'), ('X3', 'X1')]
print(nodes)
# ['X1', 'X2', 'X3']
```
これで与えたデータからネットワークの構築ができました。ちなみに、('X2', 'X1')は('親', '子')の関係なので、X2->X1となっており正しく構築できていることがわかります。  
BNではネットワークの構造とCPDが必要であることを覚えているでしょうか？  
#### 条件付き確率表を求める
そうです。ここではネットワークの構築をしただけでCPDを求めることまでできていません。さらに、構築したモデルではCPDを求めることはできません。なので、構築したネットワークを使ってCPDを求める必要があります。そのため、BayesianModelというクラスを使います。
```python
# We need to create a BayesianModel instance to estimate cpds
model = BayesianModel(list(edges))
# 独立なノードが入っていない場合にも対応
model.add_nodes_from(list(nodes))
model.fit(data) # learn cpds
cpds = model.get_cpds()
for cpd in cpds:
  print(cpd, '\n')

# +-------+-------+-------+-------+-------+
# | X2    | X2(0) | X2(0) | X2(1) | X2(1) |
# +-------+-------+-------+-------+-------+
# | X3    | X3(0) | X3(1) | X3(0) | X3(1) |
# +-------+-------+-------+-------+-------+
# | X1(0) | 1.0   | 0.0   | 0.0   | 0.0   |
# +-------+-------+-------+-------+-------+
# | X1(1) | 0.0   | 1.0   | 1.0   | 0.0   |
# +-------+-------+-------+-------+-------+
# | X1(2) | 0.0   | 0.0   | 0.0   | 1.0   |
# +-------+-------+-------+-------+-------+ 

# +-------+--------+
# | X2(0) | 0.5042 |
# +-------+--------+
# | X2(1) | 0.4958 |
# +-------+--------+ 

# +-------+--------+
# | X3(0) | 0.4992 |
# +-------+--------+
# | X3(1) | 0.5008 |
# +-------+--------+ 
```  
これでCPDを求めることができました。あとは使い道に合わせてドキュメントと同じようにプログラムを書くことでさまざまな問題に対応できます。  
#### ベイジアンネットワークから新たなデータを生成
僕はこの構築したネットワークに対して新たなデータをサンプルする必要があったので、サンプルまでやってみたいと思います。サンプル方法にもさまざまなクラスが用意されているのでドキュメントを参照してみてください。今回はBayesianModelSamplingというクラスを用います。  
```python
sampler = BayesianModelSampling(model)
new_data = sampler.forward_sample(size=10)
print(new_data.head())
#    X3  X2  X1
# 0   1   1   2
# 1   1   0   1
# 2   1   0   1
# 3   1   0   1
# 4   1   1   2
```
新たらデータが生成されました。ここで注意するのがサンプルデータのcolumnsの順序です。BNのサンプルは親のいないノードから確率的に生成するので、順序がX1, X2, X3ではないことがわかります。このnew_dataはpandasのDataFrameになっているので、入れ替えるのは容易にできます。

## まとめ
今回はベイジアンネットワークを使うことがあったのでpythonで使う方法をpgmpyというライブラリを使って説明しました。今回紹介したやり方だけでなく、ネットワークに対してある事象がわかった時の原因を探ることもできます。詳しくはドキュメントを参照してみてください。本記事はpgmpyを使った時に学習したネットワークからどうやってCPDを計算するのか、そして新たなデータをサンプルするのかを試行錯誤の上で見つけた一つの方法になります。別の方法があればTwitterでDMくださると嬉しいです。

では、今回はこの辺で！m(_ _)m