---
title: "pgmpyを使ってあそぼ~ベイジアンネットワーク~"
date: 2021-02-04T02:05:51+09:00
draft: true
tags: ["Bayesian-Network"]
categories: ["Statistics"]
images: ["/images/thumbnails/bayesian-net.png"]
---

こんにちは、ぬまです。  
今回はpythonで「pgmpy」というライブラリを使って観測データからベイジアンネットワークを構築して、構築したネットワークから新たなデータをサンプルすることをしてみようと思います。  
ベイジアンネットワークを使う機会があったのですが、調べても該当する記事が無かったり、さまざまなライブラリがある中で僕がやりたいこととマッチする記事やライブラリがうまく見つからなかったため、今後ベイジアンネットワークを使う人のためや僕自身のメモとして残そうと思います。  
本記事はベイジアンネットワークってなんぞや、という人から、ベイジアンネットワーク使おうとしているけどいまいちプログラムが書けないという人を想定していますので、ベイジアンネットワークを１から実装しようとしている人や、ベイジアンネットワーク完全理解したよー✋という人は想定していないので、悪しからず。  

## ベイジアンネットワークとは
そもそも、ベイジアンネットワーク(以下、BN)とは、さまざまな物事の因果関係をグラフとして表わすことで視覚的に理解することができる且つ物事の関係性を確率で表すことができる非循環有向グラフ(以下、DAG)です。ざっくりいうとベイズの定理によるグラフ構造ですね！
(DAGとは、ネットワーク間に矢印があり、矢印をたどっても絶対にループがないグラフのこと。)  
これだけで、BNを理解できた人は天才です。僕には呪文にしか感じませんでした。。  
例えば、以下のようなネットワークがあったとします。
{{< figure src="/images/BN-ex.png" class="center" width="200" >}}  
X1, X2, X3の丸のことをノードといい、ノードから出ている矢印のことを辺、もしくはエッジと言います。BNでは、各ノードが確率変数になっていて、例えば、事象X1が起こる確率は事象X2と事象X3に依存していることがわかります。  
BNのうれしいことはX1が起きた時に原因がX2なのかX3なのか確率的に予測できるという点です。今、以下の図のような確率がわかっているとします。   
{{< figure src="/images/BN-cpds.png" class="center" width="500" >}}  
この表からわかることは、X2, X3それぞれの0,1の起こる確率とX2, X3がわかった時のX1の0,1の確率がわかるということです(1=起きた, 0=起きていない)。この表のことを条件付き確率表(CPD)といいBNではこの表とネットワークの構造がわからないとなにもできません。  
#### ベイズの定理を使って原因を探る  
では、ベイズの定理を使ってX1が1だとわかった時に、それが何が原因である確率が高いのか調べたいと思います。  
まず、P(X1=1)の確率を知りたいので、周辺化します。  
$$P(X1=1,X2=0,X3=0) = P(X1=1|X2=0,X3=0)P(X2=0)P(X3=0) $$
$$ = 0.4 \times 0.7 \times 0.4 = 0.112$$
$$P(X1=1,X2=0,X3=1) = P(X1=1|X2=0,X3=1)P(X2=0)P(X3=1)$$
$$= 0.8\times0.7\times0.6=0.336$$
$$P(X1=1,X2=1,X3=0) = P(X1=1|X2=1,X3=0)P(X2=1)P(X3=0)$$
$$= 0.5\times0.3\times0.4=0.06$$
$$P(X1=1,X2=1,X3=1) = P(X1=1|X2=1,X3=1)P(X2=1)P(X3=1)$$
$$= 0.7\times0.3\times0.6=0.126$$
$$∴P(X1=1) = 0.634$$
周辺化できたので、実際に各確率を計算してみます。
$$P(X2=0, X3=0|X1=1)=\frac{P(X1=1|X2=0, X3=0)P(X2=0, X3=0)}{P(X1=1)}$$
$$= \frac{0.4\times0.7\times0.4}{0.634}$$
$$=0.1766$$
$$P(X2=0, X3=1|X1=1)=\frac{P(X1=1|X2=0, X3=1)P(X2=0, X3=1)}{P(X1=1)}$$
$$= \frac{0.8\times0.7\times0.6}{0.634}$$
$$=0.5299$$
$$P(X2=1, X3=0|X1=1)=\frac{P(X1=1|X2=1, X3=0)P(X2=1, X3=0)}{P(X1=1)}$$
$$= \frac{0.5\times0.3\times0.4}{0.634}$$
$$=0.0946$$
$$P(X2=1, X3=1|X1=1)=\frac{P(X1=1|X2=1, X3=1)P(X2=1, X3=1)}{P(X1=1)}$$
$$= \frac{0.7\times0.3\times0.6}{0.634}$$
$$=0.1987$$
以上より、$$P(X2=0, X3=1|X1=1)=0.5299$$
が一番確率が高いことがわかるので、X1が起きた時に53%程度の確率でX3が原因であるということがわかりました。BNの恩恵はわかりましたか？  
## pgmpyを使ってBNを構築してみる
以上の例は、BNが事前にわかっているため利用することができました。BNの構造がわかっていない状態ではどうするのか、プログラムを書いてやっていきましょう！